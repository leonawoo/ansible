---
- name: Check connectivity to Windows hosts
  hosts: windows
  gather_facts: no
  tasks:
    - block:
        - name: Ping Windows hosts to check connectivity
          win_ping:
          register: ping_result
          ignore_unreachable: yes

      rescue:
        - name: Wait before retry
          wait_for_connection:
            delay: 60
            timeout: 300
          when: ping_result is undefined or ping_result.failed

        - name: Retry pinging Windows hosts
          win_ping:
          register: ping_result
          until: ping_result is success
          retries: 5
          delay: 10
